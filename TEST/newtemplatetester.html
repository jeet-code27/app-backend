<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Template Management Test</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
</head>
<body class="bg-gray-100 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <h1 class="text-3xl font-bold text-center mb-8">Template Management Test</h1>
        
        <!-- Template Form Section -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-8">
            <h2 class="text-xl font-semibold mb-4">Create/Update Template</h2>
            
            <form id="templateForm" class="space-y-4">
                <input type="hidden" id="templateId">
                
                <!-- Title -->
                <div>
                    <label for="title" class="block text-sm font-medium text-gray-700">Template Title</label>
                    <input type="text" id="title" name="title" 
                           class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                
                <!-- Description -->
                <div>
                    <label for="description" class="block text-sm font-medium text-gray-700">Description</label>
                    <textarea id="description" name="description" rows="3"
                              class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"></textarea>
                </div>
                
                <!-- Category Dropdown -->
                <div>
                    <label for="category" class="block text-sm font-medium text-gray-700">Category</label>
                    <select id="category" name="category"
                            class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                        <option value="">Select a category</option>
                        <!-- Categories will be loaded via API -->
                    </select>
                </div>
                
                <!-- Service Dropdown (depends on category selection) -->
                <div>
                    <label for="service" class="block text-sm font-medium text-gray-700">Service</label>
                    <select id="service" name="service" disabled
                            class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 bg-gray-100">
                        <option value="">Select a category first</option>
                    </select>
                </div>
                
                <!-- Status Toggles -->
                <div class="flex space-x-4">
                    <div class="flex items-center">
                        <input id="isActive" name="isActive" type="checkbox" checked
                               class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded">
                        <label for="isActive" class="ml-2 block text-sm text-gray-700">Active</label>
                    </div>
                    <div class="flex items-center">
                        <input id="isFeatured" name="isFeatured" type="checkbox"
                               class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded">
                        <label for="isFeatured" class="ml-2 block text-sm text-gray-700">Featured</label>
                    </div>
                </div>
                
                <!-- Image Uploads -->
                <div>
                    <label class="block text-sm font-medium text-gray-700">Main Image</label>
                    <div class="mt-1 flex items-center">
                        <input type="file" id="mainImage" name="mainImage" accept="image/*"
                               class="py-2 px-3 border border-gray-300 rounded-md text-sm shadow-sm">
                    </div>
                    <div id="mainImagePreview" class="mt-2 hidden">
                        <img id="mainImagePreviewImg" src="#" alt="Main image preview" class="h-32 object-contain">
                    </div>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700">Additional Images (max 10)</label>
                    <div class="mt-1 flex items-center">
                        <input type="file" id="images" name="images" multiple accept="image/*"
                               class="py-2 px-3 border border-gray-300 rounded-md text-sm shadow-sm">
                    </div>
                    <div id="imagesPreview" class="mt-2 grid grid-cols-3 gap-2 hidden">
                        <!-- Additional images preview will be added here -->
                    </div>
                </div>
                
                <!-- Form Actions -->
                <div class="flex space-x-3 pt-4">
                    <button type="submit" id="createBtn" class="inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                        Create Template
                    </button>
                    <button type="button" id="updateBtn" class="hidden inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
                        Update Template
                    </button>
                    <button type="button" id="cancelBtn" class="hidden inline-flex justify-center py-2 px-4 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                        Cancel
                    </button>
                </div>
            </form>
        </div>
        
        <!-- Templates List Section -->
        <div class="bg-white rounded-lg shadow-md p-6">
            <h2 class="text-xl font-semibold mb-4">Templates List</h2>
            
            <div class="mb-4 flex justify-between items-center">
                <div class="flex space-x-2">
                    <input type="text" id="searchInput" placeholder="Search templates..." 
                           class="border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                    <button id="searchBtn" class="bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700">
                        Search
                    </button>
                </div>
                <div>
                    <select id="filterCategory" class="border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                        <option value="">All Categories</option>
                        <!-- Categories will be loaded via API -->
                    </select>
                </div>
            </div>
            
            <div id="templatesContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <!-- Templates will be loaded here -->
            </div>
            
            <div class="mt-4 flex justify-between items-center">
                <button id="prevPage" class="bg-gray-200 text-gray-700 px-4 py-2 rounded-md hover:bg-gray-300 disabled:opacity-50" disabled>
                    Previous
                </button>
                <span id="pageInfo" class="text-sm text-gray-600">Page 1 of 1</span>
                <button id="nextPage" class="bg-gray-200 text-gray-700 px-4 py-2 rounded-md hover:bg-gray-300 disabled:opacity-50" disabled>
                    Next
                </button>
            </div>
        </div>
    </div>

    <script>
        // Base API URL
        const API_BASE_URL = 'http://localhost:5000/api';
        
        // Current state
        let currentPage = 1;
        let totalPages = 1;
        let editingTemplateId = null;
        
        // DOM Elements
        const templateForm = document.getElementById('templateForm');
        const createBtn = document.getElementById('createBtn');
        const updateBtn = document.getElementById('updateBtn');
        const cancelBtn = document.getElementById('cancelBtn');
        const categorySelect = document.getElementById('category');
        const serviceSelect = document.getElementById('service');
        const filterCategory = document.getElementById('filterCategory');
        const searchInput = document.getElementById('searchInput');
        const searchBtn = document.getElementById('searchBtn');
        const templatesContainer = document.getElementById('templatesContainer');
        const prevPageBtn = document.getElementById('prevPage');
        const nextPageBtn = document.getElementById('nextPage');
        const pageInfo = document.getElementById('pageInfo');
        const mainImageInput = document.getElementById('mainImage');
        const mainImagePreview = document.getElementById('mainImagePreview');
        const mainImagePreviewImg = document.getElementById('mainImagePreviewImg');
        const imagesInput = document.getElementById('images');
        const imagesPreview = document.getElementById('imagesPreview');
        
        // Initialize the page
        document.addEventListener('DOMContentLoaded', () => {
            loadCategories();
            loadTemplates();
            
            // Event listeners
            categorySelect.addEventListener('change', loadServicesForCategory);
            filterCategory.addEventListener('change', () => {
                currentPage = 1;
                loadTemplates();
            });
            searchBtn.addEventListener('click', () => {
                currentPage = 1;
                loadTemplates();
            });
            prevPageBtn.addEventListener('click', () => {
                if (currentPage > 1) {
                    currentPage--;
                    loadTemplates();
                }
            });
            nextPageBtn.addEventListener('click', () => {
                if (currentPage < totalPages) {
                    currentPage++;
                    loadTemplates();
                }
            });
            templateForm.addEventListener('submit', handleFormSubmit);
            cancelBtn.addEventListener('click', resetForm);
            mainImageInput.addEventListener('change', previewMainImage);
            imagesInput.addEventListener('change', previewAdditionalImages);
        });
        
        // Load all categories for dropdowns
        async function loadCategories() {
            try {
                const response = await axios.get(`${API_BASE_URL}/categories`);
                const categories = response.data.data || [];
                
                // Populate category dropdown in form
                categorySelect.innerHTML = '<option value="">Select a category</option>';
                categories.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category._id;
                    option.textContent = category.title;
                    categorySelect.appendChild(option);
                });
                
                // Populate category filter dropdown
                filterCategory.innerHTML = '<option value="">All Categories</option>';
                categories.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category._id;
                    option.textContent = category.title;
                    filterCategory.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading categories:', error);
                alert('Failed to load categories. Check console for details.');
            }
        }
        
        // Load services for selected category
        async function loadServicesForCategory() {
            const categoryId = categorySelect.value;
            
            if (!categoryId) {
                serviceSelect.disabled = true;
                serviceSelect.innerHTML = '<option value="">Select a category first</option>';
                return;
            }
            
            try {
                serviceSelect.disabled = true;
                serviceSelect.innerHTML = '<option value="">Loading services...</option>';
                
                const response = await axios.get(`${API_BASE_URL}/templates/services-by-category/${categoryId}`);
                const services = response.data.data || [];
                
                serviceSelect.innerHTML = '<option value="">Select a service</option>';
                services.forEach(service => {
                    const option = document.createElement('option');
                    option.value = service._id;
                    option.textContent = service.title;
                    serviceSelect.appendChild(option);
                });
                
                serviceSelect.disabled = false;
            } catch (error) {
                console.error('Error loading services:', error);
                serviceSelect.innerHTML = '<option value="">Error loading services</option>';
            }
        }
        
        // Load templates with pagination and filtering
        async function loadTemplates() {
            try {
                const categoryFilter = filterCategory.value;
                const searchQuery = searchInput.value.trim();
                
                let url = `${API_BASE_URL}/templates?page=${currentPage}&limit=9`;
                if (categoryFilter) url += `&category=${categoryFilter}`;
                if (searchQuery) url += `&search=${encodeURIComponent(searchQuery)}`;
                
                const response = await axios.get(url);
                const templates = response.data.data || [];
                totalPages = response.data.pagination?.totalPages || 1;
                
                // Update pagination controls
                pageInfo.textContent = `Page ${currentPage} of ${totalPages}`;
                prevPageBtn.disabled = currentPage <= 1;
                nextPageBtn.disabled = currentPage >= totalPages;
                
                // Render templates
                templatesContainer.innerHTML = '';
                if (templates.length === 0) {
                    templatesContainer.innerHTML = '<p class="text-gray-500 col-span-3 text-center py-4">No templates found</p>';
                    return;
                }
                
                templates.forEach(template => {
                    const templateCard = document.createElement('div');
                    templateCard.className = 'border rounded-lg overflow-hidden bg-white';
                    
                    const mainImage = template.mainImage?.url || 'https://via.placeholder.com/300x200?text=No+Image';
                    const categoryName = template.category?.title || 'Unknown Category';
                    const serviceName = template.service?.title || 'Unknown Service';
                    
                    templateCard.innerHTML = `
                        <div class="h-48 bg-gray-100 overflow-hidden">
                            <img src="${mainImage}" alt="${template.title}" class="w-full h-full object-cover">
                        </div>
                        <div class="p-4">
                            <h3 class="font-semibold text-lg mb-1">${template.title}</h3>
                            <p class="text-sm text-gray-600 mb-2">${categoryName} / ${serviceName}</p>
                            <p class="text-sm text-gray-700 mb-3 line-clamp-2">${template.description || 'No description'}</p>
                            <div class="flex justify-between items-center">
                                <span class="text-xs bg-${template.isActive ? 'green' : 'red'}-100 text-${template.isActive ? 'green' : 'red'}-800 px-2 py-1 rounded">
                                    ${template.isActive ? 'Active' : 'Inactive'}
                                </span>
                                <div class="flex space-x-2">
                                    <button class="edit-btn text-indigo-600 hover:text-indigo-800" data-id="${template._id}">
                                        Edit
                                    </button>
                                    <button class="delete-btn text-red-600 hover:text-red-800" data-id="${template._id}">
                                        Delete
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    templatesContainer.appendChild(templateCard);
                });
                
                // Add event listeners to edit/delete buttons
                document.querySelectorAll('.edit-btn').forEach(btn => {
                    btn.addEventListener('click', () => editTemplate(btn.dataset.id));
                });
                
                document.querySelectorAll('.delete-btn').forEach(btn => {
                    btn.addEventListener('click', () => deleteTemplate(btn.dataset.id));
                });
            } catch (error) {
                console.error('Error loading templates:', error);
                templatesContainer.innerHTML = '<p class="text-red-500 col-span-3 text-center py-4">Error loading templates</p>';
            }
        }
        
        // Handle form submission (create/update)
        async function handleFormSubmit(e) {
            e.preventDefault();
            
            const formData = new FormData();
            const templateData = {
                title: document.getElementById('title').value,
                description: document.getElementById('description').value,
                category: document.getElementById('category').value,
                service: document.getElementById('service').value,
                isActive: document.getElementById('isActive').checked,
                isFeatured: document.getElementById('isFeatured').checked
            };
            
            // Add text fields to form data
            for (const key in templateData) {
                formData.append(key, templateData[key]);
            }
            
            // Add main image if selected
            if (mainImageInput.files[0]) {
                formData.append('mainImage', mainImageInput.files[0]);
            }
            
            // Add additional images if selected
            if (imagesInput.files.length > 0) {
                for (let i = 0; i < imagesInput.files.length; i++) {
                    formData.append('images', imagesInput.files[i]);
                }
            }
            
            try {
                let response;
                
                if (editingTemplateId) {
                    // Update existing template
                    response = await axios.put(`${API_BASE_URL}/templates/${editingTemplateId}`, formData, {
                        headers: {
                            'Content-Type': 'multipart/form-data'
                        }
                    });
                    alert('Template updated successfully!');
                } else {
                    // Create new template
                    response = await axios.post(`${API_BASE_URL}/templates`, formData, {
                        headers: {
                            'Content-Type': 'multipart/form-data'
                        }
                    });
                    alert('Template created successfully!');
                }
                
                resetForm();
                loadTemplates();
            } catch (error) {
                console.error('Error saving template:', error);
                let errorMessage = 'Failed to save template';
                
                if (error.response && error.response.data && error.response.data.message) {
                    errorMessage = error.response.data.message;
                    
                    if (error.response.data.errors) {
                        errorMessage += '\n' + error.response.data.errors.map(e => e.msg).join('\n');
                    }
                }
                
                alert(errorMessage);
            }
        }
        
        // Edit template - load data into form
        async function editTemplate(id) {
            try {
                const response = await axios.get(`${API_BASE_URL}/templates/${id}`);
                const template = response.data.data;
                
                // Set form values
                document.getElementById('templateId').value = template._id;
                document.getElementById('title').value = template.title;
                document.getElementById('description').value = template.description || '';
                document.getElementById('category').value = template.category._id;
                
                // Load services for the selected category
                await loadServicesForCategory();
                
                // Wait a moment for services to load (hacky but works for demo)
                setTimeout(() => {
                    document.getElementById('service').value = template.service._id;
                }, 300);
                
                document.getElementById('isActive').checked = template.isActive;
                document.getElementById('isFeatured').checked = template.isFeatured;
                
                // Show image previews if they exist
                if (template.mainImage?.url) {
                    mainImagePreviewImg.src = template.mainImage.url;
                    mainImagePreview.classList.remove('hidden');
                }
                
                // Show update/cancel buttons instead of create
                createBtn.classList.add('hidden');
                updateBtn.classList.remove('hidden');
                cancelBtn.classList.remove('hidden');
                
                editingTemplateId = id;
                
                // Scroll to form
                templateForm.scrollIntoView({ behavior: 'smooth' });
            } catch (error) {
                console.error('Error loading template for edit:', error);
                alert('Failed to load template for editing');
            }
        }
        
        // Delete template
        async function deleteTemplate(id) {
            if (!confirm('Are you sure you want to delete this template?')) return;
            
            try {
                await axios.delete(`${API_BASE_URL}/templates/${id}`);
                alert('Template deleted successfully');
                loadTemplates();
            } catch (error) {
                console.error('Error deleting template:', error);
                alert('Failed to delete template');
            }
        }
        
        // Reset form to initial state
        function resetForm() {
            templateForm.reset();
            editingTemplateId = null;
            
            // Reset UI state
            createBtn.classList.remove('hidden');
            updateBtn.classList.add('hidden');
            cancelBtn.classList.add('hidden');
            
            // Clear image previews
            mainImagePreview.classList.add('hidden');
            mainImagePreviewImg.src = '#';
            mainImageInput.value = '';
            
            imagesPreview.classList.add('hidden');
            imagesPreview.innerHTML = '';
            imagesInput.value = '';
            
            // Reset service dropdown
            serviceSelect.disabled = true;
            serviceSelect.innerHTML = '<option value="">Select a category first</option>';
        }
        
        // Preview main image before upload
        function previewMainImage() {
            const file = mainImageInput.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    mainImagePreviewImg.src = e.target.result;
                    mainImagePreview.classList.remove('hidden');
                };
                reader.readAsDataURL(file);
            }
        }
        
        // Preview additional images before upload
        function previewAdditionalImages() {
            const files = imagesInput.files;
            if (files.length > 0) {
                imagesPreview.innerHTML = '';
                
                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    const reader = new FileReader();
                    
                    reader.onload = (e) => {
                        const imgContainer = document.createElement('div');
                        imgContainer.className = 'relative';
                        
                        const img = document.createElement('img');
                        img.src = e.target.result;
                        img.className = 'w-full h-24 object-cover rounded';
                        
                        imgContainer.appendChild(img);
                        imagesPreview.appendChild(imgContainer);
                    };
                    
                    reader.readAsDataURL(file);
                }
                
                imagesPreview.classList.remove('hidden');
            }
        }
    </script>
</body>
</html>