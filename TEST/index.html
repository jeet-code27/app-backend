<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Category API Tester</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/1.6.0/axios.min.js"></script>
</head>
<body class="bg-gray-100 min-h-screen py-8">
    <div class="container mx-auto px-4 max-w-4xl">
        <h1 class="text-3xl font-bold text-center mb-8 text-gray-800">Category API Tester</h1>
        
        <!-- API Base URL Configuration -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">API Configuration</h2>
            <div class="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4 mb-4">
                <p class="font-semibold">CORS Issue Detected!</p>
                <p class="text-sm">If you're getting CORS errors, try one of these solutions:</p>
                <ul class="text-sm mt-2 ml-4 list-disc">
                    <li>Access this page via <code>http://localhost:5500</code> instead of <code>127.0.0.1:5500</code></li>
                    <li>Update your backend CORS settings to allow <code>http://127.0.0.1:5500</code></li>
                    <li>Add <code>origin: true</code> to your CORS config for development</li>
                </ul>
            </div>
            <div class="flex gap-4">
                <input 
                    type="text" 
                    id="baseUrl" 
                    placeholder="Enter API Base URL (e.g., http://localhost:5000/api)" 
                    value="http://localhost:5000/api"
                    class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                >
                <button 
                    onclick="updateBaseUrl()" 
                    class="px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600"
                >
                    Set URL
                </button>
            </div>
        </div>

        <!-- Create Category Form -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">Create New Category</h2>
            <form id="createCategoryForm" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Title *</label>
                    <input 
                        type="text" 
                        name="title" 
                        required 
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                        placeholder="Enter category title"
                    >
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Description *</label>
                    <textarea 
                        name="description" 
                        required 
                        rows="3"
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                        placeholder="Enter category description (min 10 characters)"
                    ></textarea>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Image</label>
                    <input 
                        type="file" 
                        name="image" 
                        accept="image/*"
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                    >
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Sort Order</label>
                        <input 
                            type="number" 
                            name="sortOrder" 
                            min="0"
                            value="0"
                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                        >
                    </div>
                    
                    <div class="flex items-center">
                        <input 
                            type="checkbox" 
                            name="isActive" 
                            id="isActive"
                            checked
                            class="mr-2"
                        >
                        <label for="isActive" class="text-sm font-medium text-gray-700">Active</label>
                    </div>
                    
                    <div class="flex items-center">
                        <input 
                            type="checkbox" 
                            name="isMostDemanding" 
                            id="isMostDemanding"
                            class="mr-2"
                        >
                        <label for="isMostDemanding" class="text-sm font-medium text-gray-700">Most Demanding</label>
                    </div>
                </div>
                
                <button 
                    type="submit" 
                    class="w-full bg-green-500 text-white py-2 px-4 rounded-md hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-green-500"
                >
                    Create Category
                </button>
            </form>
        </div>

        <!-- Fetch Categories -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">Fetch Categories</h2>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
                <button 
                    onclick="fetchCategories('all')" 
                    class="bg-blue-500 text-white py-2 px-4 rounded-md hover:bg-blue-600"
                >
                    Get All Categories
                </button>
                <button 
                    onclick="fetchCategories('active')" 
                    class="bg-indigo-500 text-white py-2 px-4 rounded-md hover:bg-indigo-600"
                >
                    Get Active Only
                </button>
                <button 
                    onclick="fetchCategories('demanding')" 
                    class="bg-purple-500 text-white py-2 px-4 rounded-md hover:bg-purple-600"
                >
                    Most Demanding
                </button>
                <button 
                    onclick="clearResults()" 
                    class="bg-gray-500 text-white py-2 px-4 rounded-md hover:bg-gray-600"
                >
                    Clear Results
                </button>
            </div>
            
            <!-- Search and Filter -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                <input 
                    type="text" 
                    id="searchQuery" 
                    placeholder="Search categories..."
                    class="px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                >
                <select 
                    id="sortBy" 
                    class="px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                >
                    <option value="createdAt">Sort by Created Date</option>
                    <option value="title">Sort by Title</option>
                    <option value="sortOrder">Sort by Order</option>
                </select>
                <select 
                    id="sortOrder" 
                    class="px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                >
                    <option value="desc">Descending</option>
                    <option value="asc">Ascending</option>
                </select>
            </div>
        </div>

        <!-- Results Display -->
        <div id="results" class="bg-white rounded-lg shadow-md p-6">
            <h2 class="text-xl font-semibold mb-4">Results</h2>
            <div id="resultContent" class="text-gray-500">
                Click a fetch button to load categories...
            </div>
        </div>

        <!-- Response Display -->
        <div id="responseLog" class="bg-gray-800 text-white rounded-lg p-4 mt-6 hidden">
            <h3 class="text-lg font-semibold mb-2">API Response Log</h3>
            <pre id="responseContent" class="text-sm overflow-x-auto"></pre>
        </div>
    </div>

    <script>
        let apiBaseUrl = 'http://localhost:5000/api';

        function updateBaseUrl() {
            const newUrl = document.getElementById('baseUrl').value.trim();
            if (newUrl) {
                apiBaseUrl = newUrl.endsWith('/') ? newUrl.slice(0, -1) : newUrl;
                showResponse(`Base URL updated to: ${apiBaseUrl}`);
            }
        }

        function showResponse(data) {
            const responseLog = document.getElementById('responseLog');
            const responseContent = document.getElementById('responseContent');
            responseContent.textContent = typeof data === 'string' ? data : JSON.stringify(data, null, 2);
            responseLog.classList.remove('hidden');
        }

        function hideResponse() {
            document.getElementById('responseLog').classList.add('hidden');
        }

        // Create Category Form Handler
        document.getElementById('createCategoryForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = new FormData();
            const form = e.target;
            
            formData.append('title', form.title.value);
            formData.append('description', form.description.value);
            formData.append('sortOrder', form.sortOrder.value);
            formData.append('isActive', form.isActive.checked);
            formData.append('isMostDemanding', form.isMostDemanding.checked);
            
            if (form.image.files[0]) {
                formData.append('image', form.image.files[0]);
            }

            try {
                const response = await axios.post(`${apiBaseUrl}/categories`, formData, {
                    headers: {
                        'Content-Type': 'multipart/form-data'
                    }
                });
                
                showResponse(response.data);
                displayResult('Category created successfully!', 'success');
                form.reset();
                form.isActive.checked = true; // Reset to default
                
            } catch (error) {
                console.error('Error creating category:', error);
                showResponse(error.response?.data || error.message);
                displayResult('Error creating category. Check response log.', 'error');
            }
        });

        // Fetch Categories Functions
        async function fetchCategories(type) {
            try {
                let endpoint = '/categories';
                let params = {};

                switch (type) {
                    case 'active':
                        endpoint = '/categories/active';
                        break;
                    case 'demanding':
                        endpoint = '/categories/most-demanding';
                        break;
                    case 'all':
                    default:
                        // Add search and sort parameters
                        const search = document.getElementById('searchQuery').value.trim();
                        const sortBy = document.getElementById('sortBy').value;
                        const sortOrder = document.getElementById('sortOrder').value;
                        
                        if (search) params.search = search;
                        params.sortBy = sortBy;
                        params.sortOrder = sortOrder;
                        params.limit = 20; // Increase limit for testing
                        break;
                }

                const response = await axios.get(`${apiBaseUrl}${endpoint}`, { params });
                showResponse(response.data);
                displayCategories(response.data.data || response.data, type);
                
            } catch (error) {
                console.error('Error fetching categories:', error);
                showResponse(error.response?.data || error.message);
                displayResult('Error fetching categories. Check response log.', 'error');
            }
        }

        function displayCategories(categories, type) {
            const resultContent = document.getElementById('resultContent');
            
            if (!categories || categories.length === 0) {
                resultContent.innerHTML = '<p class="text-gray-500">No categories found.</p>';
                return;
            }

            const categoryCards = categories.map(category => `
                <div class="border border-gray-200 rounded-lg p-4 mb-4">
                    <div class="flex justify-between items-start mb-2">
                        <h3 class="text-lg font-semibold text-gray-800">${category.title}</h3>
                        <div class="flex gap-2">
                            ${category.isActive ? 
                                '<span class="bg-green-100 text-green-800 text-xs px-2 py-1 rounded-full">Active</span>' : 
                                '<span class="bg-red-100 text-red-800 text-xs px-2 py-1 rounded-full">Inactive</span>'
                            }
                            ${category.isMostDemanding ? 
                                '<span class="bg-purple-100 text-purple-800 text-xs px-2 py-1 rounded-full">Most Demanding</span>' : 
                                ''
                            }
                        </div>
                    </div>
                    
                    <p class="text-gray-600 mb-2">${category.description}</p>
                    
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-2 text-sm text-gray-500 mb-3">
                        <span><strong>ID:</strong> ${category._id}</span>
                        <span><strong>Slug:</strong> ${category.slug || 'N/A'}</span>
                        <span><strong>Sort Order:</strong> ${category.sortOrder}</span>
                        <span><strong>Created:</strong> ${new Date(category.createdAt).toLocaleDateString()}</span>
                    </div>
                    
                    ${category.image && category.image.url ? 
                        `<div class="mb-3">
                            <img src="${category.image.url}" alt="${category.title}" class="max-w-xs h-32 object-cover rounded-md">
                            <p class="text-xs text-gray-500 mt-1">Size: ${Math.round(category.image.size / 1024)}KB | ${category.image.width}x${category.image.height}</p>
                        </div>` : 
                        '<p class="text-gray-400 text-sm mb-3">No image</p>'
                    }
                    
                    <div class="flex gap-2">
                        <button 
                            onclick="toggleCategoryStatus('${category._id}')" 
                            class="bg-yellow-500 text-white px-3 py-1 rounded text-sm hover:bg-yellow-600"
                        >
                            Toggle Status
                        </button>
                        <button 
                            onclick="deleteCategory('${category._id}')" 
                            class="bg-red-500 text-white px-3 py-1 rounded text-sm hover:bg-red-600"
                        >
                            Delete
                        </button>
                        <button 
                            onclick="getCategoryById('${category._id}')" 
                            class="bg-blue-500 text-white px-3 py-1 rounded text-sm hover:bg-blue-600"
                        >
                            Get by ID
                        </button>
                    </div>
                </div>
            `).join('');

            resultContent.innerHTML = `
                <div class="mb-4">
                    <p class="text-gray-600">Found ${categories.length} categories (Type: ${type})</p>
                </div>
                ${categoryCards}
            `;
        }

        function displayResult(message, type) {
            const resultContent = document.getElementById('resultContent');
            const bgColor = type === 'success' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800';
            resultContent.innerHTML = `<div class="${bgColor} p-4 rounded-md">${message}</div>`;
        }

        function clearResults() {
            document.getElementById('resultContent').innerHTML = '<p class="text-gray-500">Results cleared.</p>';
            hideResponse();
        }

        // Additional API Functions
        async function toggleCategoryStatus(categoryId) {
            try {
                const response = await axios.patch(`${apiBaseUrl}/categories/${categoryId}/toggle-active`);
                showResponse(response.data);
                displayResult('Category status toggled successfully!', 'success');
            } catch (error) {
                console.error('Error toggling status:', error);
                showResponse(error.response?.data || error.message);
                displayResult('Error toggling category status.', 'error');
            }
        }

        async function deleteCategory(categoryId) {
            if (!confirm('Are you sure you want to delete this category?')) return;
            
            try {
                const response = await axios.delete(`${apiBaseUrl}/categories/${categoryId}`);
                showResponse(response.data);
                displayResult('Category deleted successfully!', 'success');
            } catch (error) {
                console.error('Error deleting category:', error);
                showResponse(error.response?.data || error.message);
                displayResult('Error deleting category.', 'error');
            }
        }

        async function getCategoryById(categoryId) {
            try {
                const response = await axios.get(`${apiBaseUrl}/categories/${categoryId}`);
                showResponse(response.data);
                displayCategories([response.data.data], 'single');
            } catch (error) {
                console.error('Error fetching category:', error);
                showResponse(error.response?.data || error.message);
                displayResult('Error fetching category by ID.', 'error');
            }
        }
    </script>
</body>
</html>